<!DOCTYPE html>
<html>
<head>
    <title>ê²€ ê°•í™” RPG Online - Chat & UI</title>
    <style>
        body { margin: 0; overflow: hidden; font-family: 'Malgun Gothic', sans-serif; user-select: none; background-color: #111; }
        
        /* ë°°ê²½ */
        #bg-image {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover; z-index: -1; opacity: 0.8;
        }

        /* ë²„íŠ¼ ê³µí†µ */
        .btn {
            background: linear-gradient(to bottom, #444, #222);
            border: 2px solid #888; color: white; padding: 8px 16px; border-radius: 8px;
            cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(0,0,0,0.5);
        }
        .btn:active { transform: scale(0.95); }
        .btn-enhance { background: linear-gradient(to bottom, #d32f2f, #b71c1c); border-color: #ffcdd2; }

        /* ë¡œê·¸ì¸ í™”ë©´ */
        #login-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        #nickname-input { padding: 10px; font-size: 20px; text-align: center; margin-bottom: 20px; border-radius: 5px; }

        /* --- UI ë ˆì´ì•„ì›ƒ ê°œí¸ --- */

        /* 1. ì¢Œì¸¡ ì •ë³´ì°½ (ë‹‰ë„¤ì„, ëˆ, ë¡œê·¸ í¬í•¨) */
        #ui-left-panel {
            position: absolute; top: 20px; left: 20px; width: 320px;
            pointer-events: none; /* í´ë¦­ í†µê³¼ */
            z-index: 10;
        }
        
        #user-info-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #555;
            margin-bottom: 15px;
            color: white;
        }
        .info-text { font-size: 16px; margin: 5px 0; text-shadow: 1px 1px 2px black; }
        #my-nick { font-size: 20px; font-weight: bold; color: #fff; margin-bottom: 10px; border-bottom: 1px solid #777; padding-bottom: 5px; display: block;}
        
        /* ë¡œê·¸ ë°•ìŠ¤ (ì™¼ìª½ìœ¼ë¡œ ì´ë™ë¨) */
        #log-box {
            width: 100%;
            height: 200px; /* ë†’ì´ ê³ ì • */
            display: flex; 
            flex-direction: column-reverse; /* ìµœì‹ ì´ ì•„ë˜ì— */
            gap: 5px; 
            overflow: hidden;
        }
        .log-message {
            font-size: 13px; color: white; background-color: rgba(0,0,0,0.6);
            padding: 5px 10px; border-radius: 5px;
            animation: fadeIn 0.3s;
        }

        /* 2. ìš°ì¸¡ ìƒë‹¨ (íŒë§¤ ë²„íŠ¼) */
        #ui-top-right { position: absolute; top: 20px; right: 20px; z-index: 10; }

        /* 3. ìš°ì¸¡ í•˜ë‹¨ (ì±„íŒ…ì°½) */
        #ui-chat-container {
            position: absolute; bottom: 20px; right: 20px; width: 300px; height: 400px;
            display: flex; flex-direction: column;
            z-index: 10;
        }
        #chat-messages {
            flex-grow: 1;
            background: rgba(0, 0, 0, 0.6);
            border-radius: 10px 10px 0 0;
            padding: 10px;
            overflow-y: auto;
            color: white;
            font-size: 14px;
            margin-bottom: 5px;
        }
        #chat-input-area {
            display: flex; gap: 5px;
        }
        #chat-input {
            flex-grow: 1; padding: 10px; border-radius: 5px; border: none; background: rgba(255,255,255,0.9);
        }
        #chat-btn { padding: 0 15px; }

        /* ì±„íŒ… ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .chat-msg { margin-bottom: 4px; word-wrap: break-word; }
        .chat-nick { font-weight: bold; color: #ffd700; margin-right: 5px; }
        .chat-system { color: #aaa; font-style: italic; }

        /* 4. ì¤‘ì•™ í•˜ë‹¨ (ê°•í™” ë²„íŠ¼) */
        #ui-bottom-center { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); z-index: 10; }
        #enhance-btn { width: 220px; height: 80px; font-size: 24px; }

        /* 5. ì¢Œì¸¡ í•˜ë‹¨ (ê´‘ì§ˆ) - ë¡œê·¸ ë°‘ìœ¼ë¡œ ë°°ì¹˜ */
        #ui-bottom-left { 
            position: absolute; bottom: 30px; left: 30px; z-index: 10;
        }
        #mine-btn {
            width: 90px; height: 90px; border-radius: 50%;
            background: radial-gradient(circle, #4caf50, #1b5e20);
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            border: 3px solid #a5d6a7; font-size: 14px; color: white;
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* ìŠ¤í¬ë¡¤ë°” ê¾¸ë¯¸ê¸° */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: #555; border-radius: 4px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.3); }
    </style>
</head>
<body>
    <img id="bg-image" src="/bg.jpg" onerror="this.style.display='none'">

    <div id="login-screen">
        <h1>âš”ï¸ ëŒ€ì¥ì¥ì´ í‚¤ìš°ê¸° RPG</h1>
        <p style="color:#aaa; margin-bottom: 20px;">ì„œë²„ ì—°ê²° í™•ì¸ ì¤‘...</p>
        <input type="text" id="nickname-input" placeholder="ë‹‰ë„¤ì„ (ìµœëŒ€ 8ì)" maxlength="8" onkeydown="if(event.key==='Enter') startGame()">
        <button id="start-btn" class="btn" onclick="startGame()">ì…ì¥í•˜ê¸°</button>
    </div>

    <div id="ui-left-panel">
        <div id="user-info-box">
            <span id="my-nick">ë‹‰ë„¤ì„ ë¡œë”©ì¤‘...</span>
            <div class="info-text" id="my-level" style="color:#aaa">ê°•í™”: +0ê°•</div>
            <div class="info-text" id="money-display">ğŸ’° 0 G</div>
            <div class="info-text" id="cost-display" style="color:#ff8888; font-size:14px;">(ê°•í™”ë¹„ìš©: 10 G)</div>
        </div>
        <div id="log-box"></div>
    </div>

    <div id="ui-top-right">
        <button class="btn" onclick="sellWeapon()">âš–ï¸ íŒë§¤</button>
    </div>

    <div id="ui-chat-container">
        <div id="chat-messages">
            <div class="chat-system">ì±„íŒ…ë°©ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤.</div>
        </div>
        <div id="chat-input-area">
            <input type="text" id="chat-input" placeholder="ë©”ì‹œì§€ ì…ë ¥..." onkeydown="if(event.key==='Enter') sendChat()">
            <button id="chat-btn" class="btn" onclick="sendChat()">ì „ì†¡</button>
        </div>
    </div>

    <div id="ui-bottom-center">
        <button id="enhance-btn" class="btn btn-enhance" onclick="requestEnhance()">ğŸ”¥ ê°•í™”í•˜ê¸°</button>
    </div>

    <div id="ui-bottom-left">
        <button id="mine-btn" class="btn" onclick="mineGold()">â›ï¸ ê´‘ì§ˆ<br>(+10 G)</button>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        let socket;
        try {
            socket = io();
        } catch(e) { alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨"); }

        let myId = null;
        let myNickname = "";
        const otherSwords = {};
        let mySwordGroup = null;
        let mySwordMesh = null;
        const otherUserPositions = []; 
        for(let i=0; i<20; i++) otherUserPositions.push({ idx: i, occupied: false });

        // Three.js Setup
        const scene = new THREE.Scene();
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.shadowMap.enabled = true;
        renderer.domElement.style.position = 'absolute';
        renderer.domElement.style.top = '0';
        renderer.domElement.style.zIndex = '0';
        document.body.appendChild(renderer.domElement);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 8);
        camera.lookAt(0, 1, 0);

        const light = new THREE.DirectionalLight(0xffffff, 1);
        light.position.set(-5, 10, 7);
        light.castShadow = true;
        scene.add(light);
        scene.add(new THREE.AmbientLight(0x404040));
        const backLight = new THREE.DirectionalLight(0x5555ff, 0.5);
        backLight.position.set(5, 5, -5);
        scene.add(backLight);

        function createSwordGeometry() {
            const shape = new THREE.Shape();
            shape.moveTo(0,-1.5); shape.lineTo(0.2,-1.5); shape.lineTo(0.2,-0.5);
            shape.lineTo(0.6,-0.5); shape.lineTo(0.6,0); shape.lineTo(0.25,0);
            shape.lineTo(0.15,3.5); shape.lineTo(0,4); shape.lineTo(-0.15,3.5);
            shape.lineTo(-0.25,0); shape.lineTo(-0.6,0); shape.lineTo(-0.6,-0.5);
            shape.lineTo(-0.2,-0.5); shape.lineTo(-0.2,-1.5);
            const extrudeSettings = { steps: 1, depth: 0.1, bevelEnabled: true, bevelThickness: 0.05, bevelSize: 0.05, bevelSegments: 2 };
            const geometry = new THREE.ExtrudeGeometry(shape, extrudeSettings);
            geometry.center(); return geometry;
        }

        mySwordGroup = new THREE.Group();
        const geometry = createSwordGeometry();
        const material = new THREE.MeshPhongMaterial({ color: 0x8b4513, shininess: 100 });
        mySwordMesh = new THREE.Mesh(geometry, material);
        mySwordGroup.add(mySwordMesh);
        mySwordGroup.position.set(-5, 1.5, 0);
        mySwordGroup.rotation.z = -0.1;
        scene.add(mySwordGroup);

        // --- ê¸°ëŠ¥ ë¡œì§ ---
        function startGame() {
            const input = document.getElementById("nickname-input");
            const nickname = input.value.trim();
            if(!nickname) return alert("ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”!");
            
            myNickname = nickname; // ë‹‰ë„¤ì„ ë¡œì»¬ ì €ì¥
            
            // UI ì¦‰ì‹œ ë°˜ì˜ (ëŠë‚Œí‘œ ë°©ì§€)
            document.getElementById("my-nick").innerText = `í”Œë ˆì´ì–´: ${nickname}`;
            
            socket.emit('login', nickname);
            document.getElementById("login-screen").style.display = "none";
        }

        function mineGold() { socket.emit('mine_gold'); }
        function sellWeapon() { if(confirm("íŒë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) socket.emit('sell_weapon'); }
        function requestEnhance() { socket.emit('request_enhance'); }

        // ì±„íŒ… ë³´ë‚´ê¸°
        function sendChat() {
            const input = document.getElementById("chat-input");
            const msg = input.value.trim();
            if(msg) {
                socket.emit('send_chat', msg);
                input.value = "";
            }
        }

        // --- ì†Œì¼“ ì´ë²¤íŠ¸ ---
        
        // 1. ìœ ì € ì •ë³´ ì´ˆê¸°í™” (ë‹‰ë„¤ì„ ë™ê¸°í™” í¬í•¨)
        socket.on('init_users', (users) => {
            myId = socket.id;
            if(users[myId]) {
                // ë‹‰ë„¤ì„ ì„œë²„ ë°ì´í„°ë¡œ í™•ì‹¤í•˜ê²Œ ë®ì–´ì“°ê¸°
                document.getElementById("my-nick").innerText = `í”Œë ˆì´ì–´: ${users[myId].nickname}`;
                updateMyStats(users[myId]);
                updateSwordVisual(mySwordMesh, users[myId].level, true);
            }
            for (const id in users) { if (id !== myId) createOtherSword(id, users[id]); }
        });

        // 2. ì±„íŒ… ìˆ˜ì‹ 
        socket.on('chat_message', (data) => {
            const chatBox = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-msg';
            
            if(data.type === 'system') {
                div.innerHTML = `<span class="chat-system">${data.msg}</span>`;
            } else if (data.type === 'system_bold') {
                div.innerHTML = `<span style="color:#ffd700; font-weight:bold;">${data.msg}</span>`;
            } else {
                div.innerHTML = `<span class="chat-nick">${data.nickname}:</span> <span style="color:white">${data.msg}</span>`;
            }
            
            chatBox.appendChild(div);
            chatBox.scrollTop = chatBox.scrollHeight; // ìë™ ìŠ¤í¬ë¡¤
        });

        // 3. ë¡œê·¸ ìˆ˜ì‹  (ì™¼ìª½ ë°•ìŠ¤)
        socket.on('news', (msg) => addLog(msg));
        socket.on('news_personal', (msg) => addLog(msg, "#ffa500"));

        // ... ë‚˜ë¨¸ì§€ ì‹œê°í™” ë¡œì§ ...
        socket.on('user_joined', (newUser) => createOtherSword(newUser.id, newUser));
        socket.on('user_left', (id) => {
            if (otherSwords[id]) {
                const posInfo = otherUserPositions.find(p => p.id === id);
                if(posInfo) { posInfo.occupied = false; delete posInfo.id; }
                scene.remove(otherSwords[id]); delete otherSwords[id]; 
            }
        });
        socket.on('update_stats', (data) => {
            updateMyStats(data);
            updateSwordVisual(mySwordMesh, data.level, true);
        });
        socket.on('update_visual', (data) => {
            let targetMesh = null;
            if (data.id === myId) targetMesh = mySwordMesh;
            else if (otherSwords[data.id]) targetMesh = otherSwords[data.id].children[0];

            if (targetMesh) {
                updateSwordVisual(targetMesh, data.level, data.id === myId);
                if (data.outcome === 'success') {
                    targetMesh.userData.isRotating = true;
                    targetMesh.userData.rotCount = 0;
                }
                if (data.id===myId) {
                    if(data.outcome==='success') {
                        if(data.level===13) addLog("â˜… 13ê°• ë‹¬ì„±! â˜…", "#fff");
                        else addLog("ê°•í™” ì„±ê³µ!", "#4caf50");
                    }
                    else if(data.outcome==='maintain') addLog("ê°•í™” ìœ ì§€", "#ffeb3b");
                    else addLog("ê°•í™” ì‹¤íŒ¨...", "#f44336");
                }
            }
        });

        function updateMyStats(data) {
            // ë‹‰ë„¤ì„ì´ í˜¹ì‹œ ë¹„ì–´ìˆìœ¼ë©´ ì„œë²„ ë°ì´í„°ë¡œ ì±„ìš°ê¸°
            if(data.nickname) document.getElementById("my-nick").innerText = `í”Œë ˆì´ì–´: ${data.nickname}`;
            
            const levelText = document.getElementById("my-level");
            levelText.innerText = `ê°•í™”: +${data.level}ê°•`;
            // ìƒ‰ìƒ ë¡œì§ ìƒëµ(ê¸°ì¡´ ë™ì¼)
            if(data.level===0) levelText.style.color="#aaa";
            else if(data.level<=3) levelText.style.color="#4caf50";
            else if(data.level<=6) levelText.style.color="#2196f3";
            else if(data.level<=9) levelText.style.color="#9c27b0";
            else if(data.level<=12) levelText.style.color="#ffeb3b";
            else levelText.style.color="#ffffff";

            document.getElementById("money-display").innerText = `ğŸ’° ${data.money} G`;
            document.getElementById("cost-display").innerText = `(ë¹„ìš©: ${(data.level+1)*10} G)`;
        }

        function updateSwordVisual(mesh, level, isMine) {
            const baseScale = isMine ? 0.8 : 0.25;
            const growthRate = isMine ? 0.25 : 0.05; 
            const scale = baseScale + (level * growthRate);
            mesh.scale.set(scale, scale, scale);
            let colorHex;
            if (level === 0) colorHex = 0x8B4513; 
            else if (level <= 3) colorHex = 0x00FF00;
            else if (level <= 6) colorHex = 0x0077FF;
            else if (level <= 9) colorHex = 0x9900FF;
            else if (level <= 12) colorHex = 0xFFD700;
            else colorHex = 0x111111;
            mesh.material.color.setHex(colorHex);
            if (level >= 13) mesh.material.emissive.setHex(0x333333); 
            else if (level >= 10) mesh.material.emissive.setHex(0x553300);
            else mesh.material.emissive.setHex(0x000000);
        }

        function createOtherSword(id, info) {
            if(otherSwords[id]) return;
            const posInfo = otherUserPositions.find(p => !p.occupied);
            if(!posInfo) return;
            posInfo.occupied = true; posInfo.id = id;
            const group = new THREE.Group();
            const geometry = createSwordGeometry();
            const material = new THREE.MeshPhongMaterial({ color: 0x8b4513, shininess: 100 });
            const mesh = new THREE.Mesh(geometry, material);
            group.add(mesh);
            const sprite = makeTextSprite(info.nickname);
            sprite.position.y = -2.5; sprite.scale.set(1.5, 0.75, 1);
            group.add(sprite);
            const col = posInfo.idx % 4; const row = Math.floor(posInfo.idx / 4);
            group.position.set(1.5 + (col * 1.5), 3 - (row * 2.5), 0);
            scene.add(group);
            otherSwords[id] = group;
            updateSwordVisual(mesh, info.level, false);
        }

        function makeTextSprite(message) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 256; canvas.height = 128;
            ctx.fillStyle = "rgba(0,0,0,0.5)"; ctx.fillRect(0,0,256,128);
            ctx.font = "Bold 40px Arial"; ctx.fillStyle = "white";
            ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(message, 128, 64);
            const texture = new THREE.CanvasTexture(canvas);
            const sprite = new THREE.Sprite(new THREE.SpriteMaterial({ map: texture }));
            sprite.scale.set(2, 1, 1); return sprite;
        }

        function addLog(msg, color="#fff") {
            const box = document.getElementById('log-box');
            const el = document.createElement('div');
            el.className = 'log-message'; el.innerText = msg;
            if(msg.includes("13ê°•") || msg.includes("ì¶•")) {
                el.style.borderLeft = `5px solid #ffffff`; el.style.background = "rgba(50,50,50,0.9)"; el.style.color = "#ffd700";
            } else {
                el.style.borderLeft = `3px solid ${color}`;
            }
            // ìµœì‹  ë©”ì‹œì§€ê°€ ìœ„ë¡œ ì˜¤ê²Œ (prepend) í•˜ê±°ë‚˜ ì•„ë˜ë¡œ (append + scroll).
            // ì—¬ê¸°ì„  CSS flex-direction: column-reverse ì¼ìœ¼ë¯€ë¡œ appendChild í•˜ë©´ ì•„ë˜(ì‹œê°ì  ìœ„)ì— ë¶™ìŒ
            box.appendChild(el); 
            if(box.children.length > 6) box.removeChild(box.firstChild);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(mySwordGroup) {
                mySwordGroup.rotation.y += 0.005;
                if(mySwordMesh.userData.isRotating) {
                    mySwordMesh.rotation.y += 0.2; mySwordMesh.userData.rotCount += 0.2;
                    if(mySwordMesh.userData.rotCount > 6.28) { mySwordMesh.userData.isRotating = false; mySwordMesh.rotation.y = 0; }
                }
            }
            for (const id in otherSwords) { 
                const mesh = otherSwords[id].children[0];
                if(mesh.userData.isRotating) {
                    mesh.rotation.y += 0.2; mesh.userData.rotCount += 0.2;
                    if(mesh.userData.rotCount > 6.28) { mesh.userData.isRotating = false; mesh.rotation.y = 0; }
                }
            }
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>